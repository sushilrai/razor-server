#!/bin/bash

exec >> /var/log/razor.log 2>&1

echo "Starting post_install"

# Wait for network to come up when using NetworkManager.
if service NetworkManager status >/dev/null 2>&1 && type -P nm-online; then
    nm-online -q --timeout=10 || nm-online -q -x --timeout=30
    [ "$?" -eq 0 ] || exit 1
fi

<%= render_template("set_hostname") %>

<%= render_template("store_ip") %>

# @todo lutter 2013-09-12: we should register the system with RHN; be
# careful though, since this file is also used by the CentOS installer, for
# which there is no RHN registration

#add the puppet master host entry in /etc/hosts
echo "<%= URI.parse(repo_url).host %> dellasm" >> /etc/hosts

#install the puppet agent
mkdir /tmp/mnt
mount -o nolock,username=readonly,password=readonly //<%= URI.parse(repo_url).host %>/razor /tmp/mnt
rpm -ivh /tmp/mnt/puppet-agent/rhel<%= task.os_version %>/x86_64/*.rpm
umount /tmp/mnt
rm -rf /tmp/mnt

# NTP Setting
ntp_server=<%=
    require 'erb'
    require 'pathname'
    require 'ostruct'
    require 'yaml'

    def load_file(filename, dir_name, opt={:parse_yaml => false})
      default={}
      local_dir = File.dirname(__FILE__)
      file_path = File.join(local_dir, "..", dir_name, filename)
      if File.exists?(file_path)
        if opt[:parse_yaml]
          result = YAML.load_file(file_path)
        else
          result = File.read(file_path)
        end
      end
      result ||= default
    end
    options = load_file("#{node.hostname}.yaml", task.name, :parse_yaml => true)
    (options['ntp_server'] || '').strip.size > 0 ? options['ntp_server'] : ""

%>

### NTP CONFIGURATIONS ###
if [ "$ntp_server" != "" ]; then
  cat > /etc/ntp.conf << __NTP_CONFIG__
  restrict default kod nomodify notrap noquerynopeer
  restrict 127.0.0.1
  server $ntp_server
__NTP_CONFIG__
<% if task.os_version == '7' %>
    systemctl enable ntpd.service
    systemctl start ntpd.service
<% else %>
    /sbin/chkconfig --level 345 ntpd on
    service ntpd start
<% end %>

fi


#update puppet.conf file
cat > /etc/puppet/puppet.conf << EOF
[main]
    server = dellasm
    logdir = /var/log/puppet
    rundir = /var/run/puppet
    ssldir = \$vardir/ssl
[agent]
    classfile   = \$vardir/classes.txt
    localconfig = \$vardir/localconfig
    certname    = <%= require 'asm/util'; ASM::Util.hostname_to_certname(node.hostname.split('.').first) %>

EOF

# For debugging, just in case, dump out the modified confirmation file.
echo ====================[ /etc/puppet/puppet.conf ]=========================
cat /etc/puppet/puppet.conf
echo ========================================================================

#start and enable the puppet agent
<% if task.os_version == '7' %>
systemctl enable puppet.service
systemctl start puppet.service
<% else %>
chkconfig puppet on
service puppet start
<% end %>

<%= render_template("os_complete") %>

# We are done
curl -s <%= stage_done_url("finished") %>
