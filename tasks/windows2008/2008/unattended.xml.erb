<%=
require 'erb'
require 'ostruct'
require 'asm/util'

DEFAULT_OS = 'Windows Server 2008 R2 SERVERSTANDARD'
base_dir = File.join(ASM::Util::INSTALLER_OPTS_DIR, task.base.name)

settings = ASM::Util.load_file('windows_settings.yaml', base_dir)
options = ASM::Util.load_file("#{node.hostname}.yaml", base_dir)

version = node.task.os_version.gsub('_', ' ')
version = DEFAULT_OS if version == '2008'
os = OpenStruct.new
os.version = version
os.license = options['product_key'] || settings[windows_version]['license']

if options['os_type'] == 'hyperv'
  content = ASM::Util.load_file('hyper-v-unattended.xml.erb', base_dir)
else
  content = ASM::Util.load_file('default-unattended.xml.erb', base_dir)
end

ERB.new(content).result(binding)
%>
